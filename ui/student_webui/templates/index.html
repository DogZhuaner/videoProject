<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生端 - 电路配盘接线系统</title>

    <!-- Bootstrap 5 CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="/static/js/socket.io.min.js"></script>
    <!-- Vue.js 3 -->
    <script src="/static/js/vue.global.js"></script>
    <!-- AOS Animation -->
    <link href="/static/css/aos.css" rel="stylesheet">
    <script src="/static/js/aos.js"></script>
    <!-- Chart.js -->
    <script src="/static/js/chart.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #3730a3;
            --success-color: #10b981;
            --success-dark: #059669;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 20px;
            overflow: hidden;
        }

        .header-gradient {
            background: linear-gradient(135deg, var(--primary-color), var(--info-color), var(--success-color));
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            color: white;
            position: relative;
            overflow: hidden;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .card-custom {
            border: none;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-custom:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .btn-custom {
            border-radius: 16px;
            padding: 14px 32px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-start:hover {
            background: linear-gradient(135deg, var(--success-dark), var(--success-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-stop:hover {
            background: linear-gradient(135deg, var(--danger-dark), var(--danger-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
        }

        .btn-ai {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.6);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2563eb, var(--info-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, var(--warning-dark), var(--warning-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
        }

        .score-display {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 3px solid var(--warning-color);
            border-radius: 20px;
            padding: 20px 30px;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--warning-color);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .score-high {
            background: linear-gradient(135deg, #dcfce7, #d1fae5);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .score-medium {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .score-low {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .table-custom {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-custom th {
            background: linear-gradient(135deg, var(--light-bg), #f1f5f9);
            border: none;
            font-weight: 700;
            color: var(--text-primary);
            padding: 16px 12px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-custom td {
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 16px 12px;
            vertical-align: middle;
        }

        .table-custom tbody tr {
            transition: all 0.3s ease;
        }

        .table-custom tbody tr:hover {
            background: rgba(79, 70, 229, 0.05);
            transform: scale(1.01);
        }

        .badge {
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .chat-container {
            height: 450px;
            overflow-y: auto;
            background: var(--light-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 20px;
            padding: 16px 20px;
            border-radius: 20px;
            max-width: 85%;
            position: relative;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            margin-left: auto;
            box-shadow: var(--shadow-md);
        }

        .message.ai {
            background: white;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            position: relative;
        }

        .status-connected {
            background: var(--success-color);
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        .status-disconnected {
            background: var(--danger-color);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            border-radius: 16px;
            border: none;
            padding: 16px 20px;
            font-weight: 500;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: var(--primary-dark);
            border-left: 4px solid var(--primary-color);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            border-radius: 20px 20px 0 0;
            border: none;
            padding: 1.5rem;
        }

        .form-control {
            border-radius: 12px;
            border: 2px solid var(--border-color);
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .student-info-card {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(59, 130, 246, 0.1));
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(79, 70, 229, 0.2);
            margin-bottom: 20px;
        }

        .question-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .question-content pre {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            margin: 20px 0;
        }

        .modal-xl {
            max-width: 90%;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .message-header {
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .message-content {
            line-height: 1.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 16px;
            }

            .btn-custom {
                padding: 12px 24px;
                font-size: 0.9rem;
            }

            .score-display {
                font-size: 1.4rem;
                padding: 16px 24px;
            }
        }

        .card-ai {
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border-left: 8px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(59, 130, 246, 0.1));
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-visual {
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border-left: 8px solid var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-question {
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border-left: 8px solid var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-header-ai {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 16px 16px 0 0;
            padding: 16px;
        }
        .card-header-visual {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 16px 16px 0 0;
            padding: 16px;
        }
        .card-header-question {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-dark));
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 16px 16px 0 0;
            padding: 16px;
        }

        /* 状态栏样式 */
        .status-bars {
            display: flex;
            gap: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-bar-item {
            flex: 1;
            text-align: center;
        }

        .status-label {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-size: 0.95rem;
            font-weight: normal;
            padding: 16px 12px;
            border-radius: 6px;
            background-color: white;
            display: inline-block;
            min-width: 120px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: var(--text-primary);
        }

        .air-switch-closed {
            color: #28a745;
            border: 2px solid #28a745;
        }

        .air-switch-open {
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .error-wiring-count {
            color: #ffc107;
            border: 2px solid #ffc107;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .status-bars {
                flex-direction: column;
                gap: 10px;
            }

            .status-value {
                min-width: auto;
            }

            /* 实时接线触点样式 */
            .contacts-display {
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 12px;
                margin-top: 8px;
            }

            .contact-item {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
            }

            .contact-item:last-child {
                margin-bottom: 0;
            }

            .contact-label {
                font-weight: 600;
                color: #6c757d;
                min-width: 80px;
            }

            .contact-value {
                font-weight: 700;
                color: #0d6efd;
            }
        }
    </style>
</head>
<body>
    {% raw %}
    <div id="app" class="container-fluid py-4">
        <div class="main-container" data-aos="fade-up" data-aos-duration="1000">
            <!-- 头部 -->
            <div class="header-gradient p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-0" data-aos="fade-right" data-aos-delay="200">
                            <i class="bi bi-lightning-charge me-3"></i>
                            学生端 - 电路配盘接线系统
                        </h1>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex align-items-center justify-content-end" data-aos="fade-left" data-aos-delay="400">
                            <span class="status-indicator" :class="connectionStatus"></span>
                            <span class="text-white fw-semibold">{{ connectionText }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 学生信息 -->
            <div class="student-info-card" data-aos="fade-up" data-aos-delay="300">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-person-circle me-2"></i>
                            学号：{{ studentInfo.student_id || '未登录' }}
                        </h5>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-primary mb-2">
                            <i class="bi bi-person me-2"></i>
                            姓名：{{ studentInfo.student_name || '未登录' }}
                        </h5>
                    </div>
                </div>
            </div>

            <!-- 主要内容 -->
            <div class="p-4">
                <div class="row">
                    <!-- 左侧：控制面板 -->
                    <div class="col-lg-4 mb-4">
                        <div class="card card-custom h-100" data-aos="fade-right" data-aos-delay="400">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-gear me-2"></i>
                                    操作控制
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 得分显示 -->
                                <div class="text-center mb-4" data-aos="zoom-in" data-aos-delay="600">
                                    <div class="score-display" :class="scoreClass">
                                        <i class="bi bi-trophy me-2"></i>
                                        得分：{{ currentScore }}分
                                    </div>
                                </div>

                                <!-- 考试规则选择 -->
                                <div class="mb-4" data-aos="fade-up" data-aos-delay="650">
                                    <label class="form-label text-muted">
                                        <i class="bi bi-list-ul me-2"></i>
                                        选择考试规则
                                    </label>
                                    <select v-model="selectedRule" class="form-select" @change="confirmRuleSelection">
                                        <option value="">-- 请选择规则文件 --</option>
                                        <option v-for="rule in availableRules" :value="rule">{{ rule }}</option>
                                    </select>
                                </div>

                                <!-- 服务器URL输入 -->
                                <div class="mb-4" data-aos="fade-up" data-aos-delay="700">
                                    <label class="form-label text-muted">
                                        <i class="bi bi-server me-2"></i>
                                        上传服务器URL
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">http://</span>
                                        <input type="text" 
                                               class="form-control" 
                                               v-model="uploadServerUrl"
                                               placeholder="服务器地址:端口">
                                    </div>
                                    <div class="form-text">
                                        请输入文件上传的目标服务器地址
                                    </div>
                                </div>
                                
                                <!-- 文件上传 -->
                                <div class="mb-4" data-aos="fade-up" data-aos-delay="750">
                                    <label class="form-label text-muted">
                                        <i class="bi bi-file-arrow-up me-2"></i>
                                        上传文件（支持压缩包）
                                    </label>
                                    <div class="input-group">
                                        <input type="file" 
                                               class="form-control" 
                                               id="fileUpload" 
                                               accept=".zip,.rar,.7z,.tar.gz,.tgz" 
                                               @change="handleFileUpload">
                                    </div>
                                    <div class="form-text">
                                        支持的格式：.zip, .rar, .7z, .tar.gz, .tgz
                                    </div>
                                </div>

                                <!-- 实时接线触点显示 -->
                                <div class="mb-4" data-aos="fade-up" data-aos-delay="700">
                                    <h6 class="text-muted mb-2">
                                        <i class="bi bi-plug me-2"></i>
                                        实时接线触点
                                    </h6>
                                    <div class="contacts-display">
                                        <div v-if="latestContacts.length > 0" class="contact-item">
                                            <span class="contact-label">最新接线：</span>
                                            <span class="contact-value">{{ latestContacts[0] }} ↔ {{ latestContacts[1] }}</span>
                                        </div>
                                        <div v-else class="contact-item">
                                            <span class="contact-label">最新接线：</span>
                                            <span class="contact-value text-muted">暂无接线</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 控制按钮 -->
                                <div class="d-grid gap-3">
                                    <button
                                        @click="startDetection"
                                        :disabled="detectionRunning || loading"
                                        class="btn btn-custom btn-start"
                                        data-aos="fade-up" data-aos-delay="700">
                                        <i class="bi bi-play-circle me-2"></i>
                                        {{ detectionRunning ? '检测运行中...' : '开始接线操作' }}
                                        <span v-if="loading" class="loading-spinner ms-2"></span>
                                    </button>

                                    <button
                                        @click="stopDetection"
                                        :disabled="!detectionRunning || loading"
                                        class="btn btn-custom btn-stop"
                                        data-aos="fade-up" data-aos-delay="800">
                                        <i class="bi bi-stop-circle me-2"></i>
                                        停止接线操作
                                    </button>

                                    <button
                                        @click="openAiChat"
                                        class="btn btn-custom btn-ai"
                                        data-aos="fade-up" data-aos-delay="900">
                                        <i class="bi bi-robot me-2"></i>
                                        AI大模型对话
                                    </button>

                                    <button
                                        @click="openDataVisualization"
                                        class="btn btn-custom btn-info"
                                        data-aos="fade-up" data-aos-delay="1000">
                                        <i class="bi bi-graph-up me-2"></i>
                                        成绩数据可视化
                                    </button>

                                    <button
                                        @click="openQuestionGeneration"
                                        class="btn btn-custom btn-warning"
                                        data-aos="fade-up" data-aos-delay="1100">
                                        <i class="bi bi-question-circle me-2"></i>
                                        知识点题目生成
                                    </button>
                                </div>

                                <!-- 状态信息 -->
                                <div class="mt-4" data-aos="fade-up" data-aos-delay="1000">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>状态：</strong>{{ statusMessage }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：实时接线情况和题目信息 -->
                    <div class="col-lg-8">
                        <!-- 实时接线情况 -->
                        <div class="card card-custom" data-aos="fade-left" data-aos-delay="500">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-table me-2"></i>
                                    实时接线情况
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 空气开关状态和错误接线次数状态栏 -->
                                <div class="status-bars mb-4">
                                    <div class="status-bar-item">
                                        <div class="status-label">空气开关状态</div>
                                        <div class="status-value" :class="{ 'air-switch-closed': airSwitchClosed, 'air-switch-open': !airSwitchClosed }">
                                            <i class="bi bi-power me-2"></i>
                                            {{ airSwitchClosed ? '已闭合' : '未闭合' }}
                                        </div>
                                    </div>
                                    <div class="status-bar-item">
                                        <div class="status-label">违规操作次数</div>
                                        <div class="status-value error-wiring-count">
                                            <i class="bi bi-x-circle me-2"></i>
                                            {{ errorWiringCount }}次
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>导线一端</th>
                                                <th>导线另一端</th>
                                                <th>操作</th>
                                                <th>得分</th>
                                                <th>时间</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 显示接线结果 -->
                                            <tr v-for="(result, index) in wiringResults" :key="result.id" data-aos="fade-up">
                                                <td>{{ index + 1 }}</td>
                                                <td>{{ result.end1 }}</td>
                                                <td>{{ result.end2 }}</td>
                                                <td>
                                                    <span
                                                        class="badge"
                                                        :class="result.action === '连接导线' ? 'bg-success' : (result.action === '拆除导线' ? 'bg-warning' : 'bg-secondary')">
                                                        {{ result.action || '未知操作' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span
                                                        class="badge"
                                                        :class="result.score >= 0 ? 'bg-success' : 'bg-danger'">
                                                        {{ result.score }}分
                                                    </span>
                                                </td>
                                                <td>{{ result.timestamp }}</td>
                                            </tr>
                                            
                                            <tr v-if="wiringResults.length === 0">
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                                    暂无接线记录
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 接线历史记录 -->
                        <div class="card card-custom mb-4" data-aos="fade-left" data-aos-delay="600">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock-history me-2"></i>
                                    接线历史记录
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 新增接线表格 -->
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    新增接线
                                </h6>
                                <div class="table-responsive mb-4">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>触点1</th>
                                                <th>触点2</th>
                                                <th>得分</th>
                                                <th>时间</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(pair, index) in addPairs" :key="'add-' + index">
                                                <td>{{ index + 1 }}</td>
                                                <td>{{ pair.contact1 }}</td>
                                                <td>{{ pair.contact2 }}</td>
                                                <td>
                                                    <span class="badge bg-success">+{{ pair.score || 0 }}分</span>
                                                </td>
                                                <td>{{ pair.timestamp || new Date().toLocaleString() }}</td>
                                            </tr>
                                            <tr v-if="addPairs.length === 0">
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    暂无新增接线记录
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- 拆除接线表格 -->
                                <h6 class="text-warning mb-3">
                                    <i class="bi bi-dash-circle me-2"></i>
                                    拆除接线
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>触点1</th>
                                                <th>触点2</th>
                                                <th>得分</th>
                                                <th>时间</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(pair, index) in undoPairs" :key="'undo-' + index">
                                                <td>{{ index + 1 }}</td>
                                                <td>{{ pair.contact1 }}</td>
                                                <td>{{ pair.contact2 }}</td>
                                                <td>
                                                    <span class="badge bg-warning">{{ pair.score || 0 }}分</span>
                                                </td>
                                                <td>{{ pair.timestamp || new Date().toLocaleString() }}</td>
                                            </tr>
                                            <tr v-if="undoPairs.length === 0">
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    暂无拆除接线记录
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 自动生成题目信息框 -->
                        <div class="card card-custom mb-4" data-aos="fade-left" data-aos-delay="600">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-question-circle me-2"></i>
                                    知识点练习题目
                                </h5>
                            </div>
                            <div class="card-body">
                                <div v-if="autoQuestionLoading" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在生成题目...</p>
                                </div>
                                <div v-else-if="autoGeneratedQuestion" class="question-content">
                                    <div class="mb-2">
                                        <strong>知识点：</strong>{{ autoGeneratedQuestion.knowledge }}
                                    </div>
                                    <div class="question-text" v-html="formatQuestion(autoGeneratedQuestion.question)">
                                    </div>
                                </div>
                                <div v-else class="text-muted">
                                    进行接线操作时，将自动生成相关知识点题目
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>

        <!-- AI对话模态框 -->
        <div class="modal fade" id="aiChatModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-robot me-2"></i>
                            AI大模型智能对话
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Ollama设置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="bi bi-gear me-2"></i>
                                大模型设置
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.ip" class="form-control" placeholder="Ollama IP" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.port" class="form-control" placeholder="端口号" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.model" class="form-control" placeholder="模型名称" />
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button @click="testAiOllamaConnection" class="btn btn-sm btn-outline-primary me-2">
                                        测试连接
                                    </button>
                                    <button @click="saveAiOllamaConfig" class="btn btn-sm btn-primary">
                                        保存设置
                                    </button>
                                </div>
                                <div v-if="aiConnectionStatus" class="mt-2">
                                    <div :class="aiConnectionStatus.success ? 'alert alert-success' : 'alert alert-danger'">
                                        {{ aiConnectionStatus.message }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 聊天记录 -->
                        <div class="chat-container mb-3">
                            <div v-for="message in chatMessages" :key="message.id" class="message" :class="message.type">
                                <div class="message-header">
                                    <small class="text-muted">{{ message.timestamp }}</small>
                                </div>
                                <div class="message-content">
                                    {{ message.content }}
                                </div>
                            </div>
                        </div>

                        <!-- 输入框 -->
                        <div class="input-group">
                            <input
                                type="text"
                                class="form-control"
                                v-model="questionInput"
                                @keyup.enter="sendQuestion"
                                placeholder="请输入您的问题..."
                                :disabled="aiLoading">
                            <button
                                class="btn btn-primary"
                                @click="sendQuestion"
                                :disabled="!questionInput.trim() || aiLoading">
                                <span v-if="aiLoading" class="loading-spinner"></span>
                                <i v-else class="bi bi-send"></i>
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据可视化模态框 -->
        <div class="modal fade" id="dataVisualizationModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title"><i class="bi bi-graph-up me-2"></i>学生成绩可视化</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 学生基本信息 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-person me-2"></i>学生信息</div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>学号：</strong>{{ studentInfo.student_id }}
                                            </div>
                                            <div class="col-6">
                                                <strong>姓名：</strong>{{ studentInfo.student_name }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-calendar-check me-2"></i>考试统计</div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h4 class="text-primary">{{ studentExams.length }}</h4>
                                                <small class="text-muted">参加考试数</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-success">{{ avgScore }}</h4>
                                                <small class="text-muted">平均成绩</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 成绩趋势图 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-line-chart me-2"></i>成绩趋势</div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 400px;">
                                            <canvas id="scoreTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 易错知识点分析 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header"><i class="bi bi-bar-chart me-2"></i>易错知识点分析</div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 400px;">
                                            <canvas id="knowledgeChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 考试成绩列表 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="bi bi-table me-2"></i>考试成绩详情
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>考试ID</th>
                                                        <th>考试名称</th>
                                                        <th>成绩</th>
                                                        <th>等级</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="score in studentScores" :key="score.test_id">
                                                        <td>{{ score.test_id }}</td>
                                                        <td>{{ score.test_name }}</td>
                                                        <td>
                                                            <span class="badge" :class="getScoreClass(score.score)">{{ score.score }}</span>
                                                        </td>
                                                        <td>
                                                            <span class="badge" :class="getScoreClass(score.score)">{{ getScoreLevel(score.score) }}</span>
                                                        </td>
                                                    </tr>
                                                    <tr v-if="studentScores.length === 0">
                                                        <td colspan="4" class="text-center text-muted py-4">
                                                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                                            暂无考试记录
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 题目生成模态框 -->
        <div class="modal fade" id="questionGenerationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="bi bi-question-circle me-2"></i>
                            知识点题目生成
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Ollama设置 -->
                        <div class="card mb-3">
                            <div class="card-header">大模型设置</div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input v-model="ollamaConfig.ip" class="form-control" placeholder="Ollama IP" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="ollamaConfig.port" class="form-control" placeholder="端口号" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="ollamaConfig.model" class="form-control" placeholder="模型名称" />
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button @click="testOllamaConnection" class="btn btn-sm btn-outline-primary me-2">
                                        测试连接
                                    </button>
                                    <button @click="saveOllamaConfig" class="btn btn-sm btn-primary">
                                        保存设置
                                    </button>
                                </div>
                                <div v-if="connectionStatus" class="mt-2">
                                    <div :class="connectionStatus.success ? 'alert alert-success' : 'alert alert-danger'">
                                        {{ connectionStatus.message }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 题目生成 -->
                        <div class="card">
                            <div class="card-header">题目生成</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">选择知识点类型（可选）：</label>
                                    <select v-model="selectedKnowledge" class="form-select">
                                        <option value="">知识点类型</option>
                                        <option v-for="knowledge in availableKnowledge" :key="knowledge" :value="knowledge">
                                            {{ knowledge }}
                                        </option>
                                    </select>
                                </div>

                                <button @click="generateQuestion" class="btn btn-success" :disabled="questionLoading">
                                    <span v-if="questionLoading" class="spinner-border spinner-border-sm me-2"></span>
                                    <i v-else class="bi bi-magic me-2"></i>
                                    生成题目
                                </button>

                                <!-- 生成的题目 -->
                                <div v-if="generatedQuestion" class="mt-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <strong>题目信息</strong>
                                            <span class="badge bg-info ms-2">{{ generatedQuestion.subject }}</span>
                                            <span class="badge bg-secondary ms-1">{{ generatedQuestion.knowledge }}</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>选择知识点：</strong>{{ generatedQuestion.knowledge }}
                                            </div>
                                            <div class="question-content">
                                                <div v-html="formatQuestion(generatedQuestion.question)"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI模型设置弹窗 -->
        <div class="modal fade" id="aiModelSettingModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header card-header-ai">
                        <h5 class="modal-title"><i class="bi bi-gear me-2"></i>AI模型设置</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Ollama设置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="bi bi-gear me-2"></i>
                                大模型设置
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.ip" class="form-control" placeholder="Ollama IP" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.port" class="form-control" placeholder="端口号" />
                                    </div>
                                    <div class="col-md-4">
                                        <input v-model="aiOllamaConfig.model" class="form-control" placeholder="模型名称" />
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button @click="testAiOllamaConnection" class="btn btn-sm btn-outline-primary me-2">
                                        测试连接
                                    </button>
                                    <button @click="saveAiOllamaConfig" class="btn btn-sm btn-primary">
                                        保存设置
                                    </button>
                                </div>
                                <div v-if="aiConnectionStatus" class="mt-2">
                                    <div :class="aiConnectionStatus.success ? 'alert alert-success' : 'alert alert-danger'">
                                        {{ aiConnectionStatus.message }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 聊天记录 -->
                        <div class="chat-container mb-3">
                            <div v-for="message in chatMessages" :key="message.id" class="message" :class="message.type">
                                <div class="message-header">
                                    <small class="text-muted">{{ message.timestamp }}</small>
                                </div>
                                <div class="message-content">
                                    {{ message.content }}
                                </div>
                            </div>
                        </div>

                        <!-- 输入框 -->
                        <div class="input-group">
                            <input
                                type="text"
                                class="form-control"
                                v-model="questionInput"
                                @keyup.enter="sendQuestion"
                                placeholder="请输入您的问题..."
                                :disabled="aiLoading">
                            <button
                                class="btn btn-primary"
                                @click="sendQuestion"
                                :disabled="!questionInput.trim() || aiLoading">
                                <span v-if="aiLoading" class="loading-spinner"></span>
                                <i v-else class="bi bi-send"></i>
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <!-- Bootstrap 5 JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化AOS动画
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        const { createApp } = Vue;

        // 创建Vue应用实例并赋值给全局变量
        window.app = createApp({
            data() {
                return {
                    // 应用初始化状态
                    ready: false,
                    
                    // 连接状态
                    connected: false,

                    // 学生信息
                    studentInfo: {
                        student_id: '',
                        student_name: ''
                    },

                    // 检测状态
                    detectionRunning: false,
                    loading: false,
                    statusMessage: '等待开始检测...',

                    // 得分
                    currentScore: 0,

                    // 接线结果
                    wiringResults: [],
                    // 最新接线触点
                    latestContacts: [],
            
                    // AI对话
                    questionInput: '',
                    aiLoading: false,
                    chatMessages: [],



                    // Socket.IO
                    socket: null,

                    // 数据可视化相关
                    studentExams: [],
                    studentScores: [],
                    studentKnowledge: [],
                    avgScore: 0,
                    availableSubjects: ['电路学'],
                    selectedSubject: '电路学',
                    availableKnowledge: [], // 改为空数组，由API动态加载
                    selectedKnowledge: '',
                    questionLoading: false,
                    generatedQuestion: null,
                    ollamaConfig: {
                        ip: 'localhost',
                        port: '11434',
                        model: 'qwen2.5:1.5b'
                    },
                    aiOllamaConfig: {
                        ip: 'localhost',
                        port: '11434',
                        model: 'qwen2.5:1.5b'
                    },
                    aiConnectionStatus: null,

                    // 新增：空气开关状态和错误接线次数
                    airSwitchClosed: false,
                    errorWiringCount: 0,
                    // 上一次的接线情况，用于避免重复记录
                    lastWiringStatus: null,
                    // 自动生成题目
                    autoGeneratedQuestion: null,
                    // 自动生成题目时的加载状态
                    autoQuestionLoading: false,
                    
                    // 考试规则选择
                    availableRules: [],
                    selectedRule: '',
                    
                    // 新增接线和拆除接线列表
                    addPairs: [],
                    undoPairs: [],
                    
                    // 文件上传服务器URL
                    uploadServerUrl: ''
                }
            },

            computed: {
                connectionStatus() {
                    return this.connected ? 'status-connected' : 'status-disconnected';
                },

                connectionText() {
                    return this.connected ? '已连接' : '未连接';
                },

                scoreClass() {
                    if (this.currentScore >= 80) return 'score-high';
                    if (this.currentScore >= 60) return 'score-medium';
                    return 'score-low';
                }
            },

            mounted() {
                this.initSocket();
                this.loadStudentInfo();
                this.loadInitialData();
                
                // 设置应用为就绪状态
                this.ready = true;

                // 初始化轮询定时器
                this.setupPolling();
                
                // 从localStorage加载Ollama配置，用于自动生成题目
                const savedIp = localStorage.getItem('ollama_ip');
                const savedPort = localStorage.getItem('ollama_port');
                const savedModel = localStorage.getItem('ollama_model');

                if (savedIp) this.ollamaConfig.ip = savedIp;
                if (savedPort) this.ollamaConfig.port = savedPort;
                if (savedModel) this.ollamaConfig.model = savedModel;
                
                // 加载知识点列表，用于自动生成题目
                this.loadKnowledgeList();
                
                // 加载可用的考试规则
                this.loadAvailableRules();
                const app = Vue.createApp({
                data() {
                  return {
                    airSwitchClosed: false,  // 空气开关状态
                    errorWiringCount: 0,     // 错误接线次数
                  };
                },
            });
                 // 在组件加载时开始定时获取数据
                setInterval(() => {
                    // 发起请求，获取空气开关状态和错误接线次数
                    fetch('/api/get_air_switch_status')
                        .then((response) => response.json())
                        .then((data) => {
                            // 根据返回的数据更新 Vue 实例中的数据
                            this.airSwitchClosed = data.airSwitchClosed;
                            this.errorWiringCount = data.errorWiringCount;
                        })
                        .catch((error) => {
                            console.error('获取数据失败:', error);
                        });
                }, 1000);  // 每1秒更新一次数据
            },


            // 组件销毁前清理资源
            beforeUnmount() {
                this.clearPolling();
                if (this.socket) {
                    this.socket.disconnect();
                }
                this.socket.on('disconnect', () => {
                    console.log('WebSocket 已断开');
                });


            },
            
            methods: {
                // 设置轮询机制（SocketIO的补充）
                setupPolling() {
                    // 统一接线情况轮询（5秒间隔）
                    this.wiringStatusPolling = setInterval(() => {
                        // 无论Socket连接状态如何，都定期获取数据以确保可靠性
                        this.getWiringStatus();
                    }, 2000); // 5秒间隔
                },
                
                // 清理轮询定时器
                clearPolling() {
                    if (this.wiringStatusPolling) {
                        clearInterval(this.wiringStatusPolling);
                        this.wiringStatusPolling = null;
                    }
                },
                
                // 初始化Socket连接
                initSocket() {
                    console.log('开始初始化Socket连接...');
                    
                    // 确保只初始化一次Socket连接
                    if (this.socket) {
                        console.log('Socket实例已存在，跳过初始化');
                        return;
                    }
                    
                    try {
                        // 明确指定socket.io服务器地址为学生端服务地址
                        const socketUrl = 'http://localhost:8088';
                        console.log('尝试连接到Socket.IO服务器:', socketUrl);
                        
                        // 确保io函数存在
                        if (typeof io === 'undefined') {
                            console.error('❌ io函数未定义，Socket.IO客户端库可能未正确加载');
                            return;
                        }
                        
                        // 创建Socket.IO连接
                        this.socket = io(socketUrl, {
                            transports: ['websocket', 'polling'], // 支持多种传输方式
                            timeout: 5000, // 设置连接超时
                            reconnection: true, // 启用自动重连
                            reconnectionAttempts: 5, // 重连尝试次数
                            reconnectionDelay: 1000, // 重连延迟
                            autoConnect: true // 自动连接
                        });
                        
                        console.log('Socket实例创建成功:', this.socket);
                        
                        // 确保this.socket是一个对象
                        if (typeof this.socket !== 'object' || this.socket === null) {
                            console.error('❌ Socket实例创建失败，返回值:', this.socket);
                            this.socket = null;
                            return;
                        }

                        // 连接事件
                        this.socket.on('connect', () => {
                            console.log('✅ Socket连接成功事件触发');
                            this.connected = true;
                            console.log('已连接到服务器，connected状态更新为:', this.connected);
                        });

                        // 连接错误事件
                        this.socket.on('connect_error', (error) => {
                            console.error('❌ Socket连接错误:', error);
                            this.connected = false;
                            console.log('Socket连接失败，connected状态更新为:', this.connected);
                        });

                        // 断开连接事件
                        this.socket.on('disconnect', (reason) => {
                            console.log('⚠️ Socket断开连接事件触发，原因:', reason);
                            this.connected = false;
                            console.log('与服务器断开连接，connected状态更新为:', this.connected);
                        });

                        // 重连尝试事件
                        this.socket.on('reconnect_attempt', (attemptNumber) => {
                            console.log('🔄 Socket重连尝试:', attemptNumber);
                        });

                        // 重连成功事件
                        this.socket.on('reconnect', (attemptNumber) => {
                            console.log('✅ Socket重连成功，尝试次数:', attemptNumber);
                            this.connected = true;
                        });

                        // 重连失败事件
                        this.socket.on('reconnect_failed', () => {
                            console.error('❌ Socket重连失败');
                            this.connected = false;
                        });



                        // 监听接线结果更新
                        this.socket.on('wiring_result', (data) => {
                            console.log('🔌 收到wiring_result事件，数据:', data);
                            if (data && typeof data === 'object') {
                                if ('contacts' in data) {
                                    console.log('🔌 wiring_result事件包含contacts字段，值为:', data.contacts);
                                    // 更新最新接线触点
                                    this.latestContacts = data.contacts;
                                    console.log('🔌 latestContacts已更新为:', this.latestContacts);
                                }
                                
                                if ('results' in data) {
                                    console.log('🔌 wiring_result事件包含results字段，值为:', data.results);
                                    this.wiringResults = data.results.map((result, index) => ({
                                        id: index + 1,
                                        end1: result.contacts ? result.contacts[0] : '',
                                        end2: result.contacts ? result.contacts[1] : '',
                                        action: result.score > 0 ? '连接导线' : (result.score < 0 ? '拆除导线' : '未知操作'),
                                        score: result.score || 0,
                                        timestamp: result.timestamp
                                    }));
                                    console.log('🔌 wiringResults已更新为:', this.wiringResults);
                                }
                            } else {
                                console.log('🔌 wiring_result事件数据为空或格式不正确');
                            }
                        });

                        // 监听完整接线结果更新
                        this.socket.on('wiring_results_update', (data) => {
                            console.log('📋 收到wiring_results_update事件，数据:', data);
                            if (data && typeof data === 'object' && 'results' in data) {
                                console.log('📋 wiring_results_update事件包含results字段，值为:', data.results);
                                this.wiringResults = data.results.map((result, index) => ({
                                    id: index + 1,
                                    end1: result.contacts ? result.contacts[0] : '',
                                    end2: result.contacts ? result.contacts[1] : '',
                                    score: result.score || 0,
                                    timestamp: result.timestamp
                                }));
                                console.log('📋 wiringResults已更新为:', this.wiringResults);
                            } else {
                                console.log('📋 wiring_results_update事件数据为空或不包含results字段');
                            }
                        });

                        // 监听匹配结果更新

                    } catch (error) {
                        console.error('❌ 初始化Socket连接时发生错误:', error);
                        this.connected = false;
                        this.socket = null;
                    }
                },

                // 加载学生信息
                async loadStudentInfo() {
                    try {
                        const response = await fetch('/api/student_info');
                        const data = await response.json();
                        this.studentInfo = data;
                    } catch (error) {
                        console.error('加载学生信息失败:', error);
                    }
                },

                // 加载初始数据
                async loadInitialData() {
                    try {
                        // 初始化接线结果
                        console.log('初始化接线结果');
                    } catch (error) {
                        console.error('加载初始数据失败:', error);
                    }
                },
                
                // 加载可用的考试规则
                async loadAvailableRules() {
                    try {
                        const response = await fetch('/api/get_rules');
                        const data = await response.json();
                        if (data.success) {
                            this.availableRules = data.rules;
                        }
                    } catch (error) {
                        console.error('加载可用考试规则失败:', error);
                    }
                },
                
                // 确认选择考试规则
                async confirmRuleSelection() {
                    if (!this.selectedRule) return;
                    
                    const confirmMessage = `确认要使用当前${this.selectedRule}考试规则吗？`;
                    if (confirm(confirmMessage)) {
                        try {
                            const response = await fetch('/api/set_rule', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ rule: this.selectedRule })
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                alert('考试规则已更新！');
                            } else {
                                alert(`更新考试规则失败: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('更新考试规则失败:', error);
                            alert('更新考试规则失败');
                        }
                    } else {
                        // 用户取消选择，重置下拉框
                        this.selectedRule = '';
                    }
                },
                
                // 处理文件上传
                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // 验证文件类型
                    const allowedExtensions = ['.zip', '.rar', '.7z', '.tar.gz', '.tgz'];
                    const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                    if (!allowedExtensions.includes(fileExtension)) {
                        alert('请上传支持的压缩包格式：.zip, .rar, .7z, .tar.gz, .tgz');
                        return;
                    }
                    
                    // 创建FormData对象
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await fetch('/api/upload_file', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            alert(`文件上传成功：${file.name}`);
                            // 重置文件输入
                            event.target.value = '';
                        } else {
                            alert(`文件上传失败：${data.message}`);
                        }
                    } catch (error) {
                        console.error('文件上传失败:', error);
                        alert('文件上传失败，请重试');
                    }
                },
                


                // 开始检测
                async startDetection() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/start_detection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.detectionRunning = true;
                            this.statusMessage = data.message;
                            this.currentScore = 0;
                            this.wiringResults = [];
                        } else {
                            alert(data.message);
                        }
                    } catch (error) {
                        console.error('启动检测失败:', error);
                        alert('启动检测失败');
                    } finally {
                        this.loading = false;
                    }
                },

                // 停止检测
                async stopDetection() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/stop_detection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        if (data.success) {
                            this.detectionRunning = false;
                            this.statusMessage = data.message;
                        } else {
                            alert(data.message);
                        }
                    } catch (error) {
                        console.error('停止检测失败:', error);
                        alert('停止检测失败');
                    } finally {
                        this.loading = false;
                    }
                },

                // 打开AI对话
                openAiChat() {
                    const modal = new bootstrap.Modal(document.getElementById('aiChatModal'));
                    modal.show();

                    // 从localStorage加载AI对话的Ollama配置
                    const savedAiIp = localStorage.getItem('ai_ollama_ip');
                    const savedAiPort = localStorage.getItem('ai_ollama_port');
                    const savedAiModel = localStorage.getItem('ai_ollama_model');

                    if (savedAiIp) this.aiOllamaConfig.ip = savedAiIp;
                    if (savedAiPort) this.aiOllamaConfig.port = savedAiPort;
                    if (savedAiModel) this.aiOllamaConfig.model = savedAiModel;
                },

                // 发送问题
                async sendQuestion() {
                    if (!this.questionInput.trim() || this.aiLoading) return;

                    const question = this.questionInput.trim();
                    this.questionInput = '';

                    // 添加用户消息
                    this.chatMessages.push({
                        id: Date.now(),
                        type: 'user',
                        content: question,
                        timestamp: new Date().toLocaleTimeString()
                    });

                    this.aiLoading = true;

                    try {
                        const response = await fetch('/api/ai_chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                question,
                                ip: this.aiOllamaConfig.ip,
                                port: parseInt(this.aiOllamaConfig.port),
                                model_name: this.aiOllamaConfig.model
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // 添加AI回复
                            this.chatMessages.push({
                                id: Date.now() + 1,
                                type: 'ai',
                                content: data.answer,
                                timestamp: data.timestamp
                            });
                        } else {
                            // 添加错误消息
                            this.chatMessages.push({
                                id: Date.now() + 1,
                                type: 'ai',
                                content: `错误：${data.message}`,
                                timestamp: new Date().toLocaleTimeString()
                            });
                        }
                    } catch (error) {
                        console.error('AI对话失败:', error);
                        this.chatMessages.push({
                            id: Date.now() + 1,
                            type: 'ai',
                            content: '网络错误，请稍后重试',
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } finally {
                        this.aiLoading = false;

                        // 滚动到底部
                        setTimeout(() => {
                            const chatContainer = document.querySelector('.chat-container');
                            if (chatContainer) {
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        }, 100);
                    }
                },

                // 生成题目
                async generateQuestion() {
                    if (!this.ollamaConfig.ip || !this.ollamaConfig.port || !this.ollamaConfig.model) {
                        alert('请先配置Ollama大模型设置！');
                        return;
                    }

                    this.questionLoading = true;
                    try {
                        const response = await fetch('/api/generate_question_by_ollama', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ip: this.ollamaConfig.ip,
                                port: parseInt(this.ollamaConfig.port),
                                model_name: this.ollamaConfig.model,
                                subject: this.selectedSubject,
                                knowledge: this.selectedKnowledge
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.generatedQuestion = data.question;
                        } else {
                            alert(`生成题目失败: ${data.message}`);
                        }
                    } catch (error) {
                        console.error('生成题目失败:', error);
                        alert('生成题目失败');
                    } finally {
                        this.questionLoading = false;
                    }
                },

                // 自动生成题目（当wired_status变化时调用）
                async autoGenerateQuestion() {
                    // 只有当Ollama配置完整且有可用知识点时才执行
                    if (!this.ollamaConfig.ip || !this.ollamaConfig.port || !this.ollamaConfig.model || 
                        !this.availableKnowledge || this.availableKnowledge.length === 0) {
                        return;
                    }
                    
                    // 随机选择一个知识点
                    const randomIndex = Math.floor(Math.random() * this.availableKnowledge.length);
                    const randomKnowledge = this.availableKnowledge[randomIndex];
                    
                    this.autoQuestionLoading = true;
                    try {
                        const response = await fetch('/api/generate_question_by_ollama', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ip: this.ollamaConfig.ip,
                                port: parseInt(this.ollamaConfig.port),
                                model_name: this.ollamaConfig.model,
                                subject: this.selectedSubject,
                                knowledge: randomKnowledge
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.autoGeneratedQuestion = data.question;
                        } else {
                            console.log(`自动生成题目失败: ${data.message}`);
                        }
                    } catch (error) {
                        console.error('自动生成题目失败:', error);
                    } finally {
                        this.autoQuestionLoading = false;
                    }
                },

                // 测试Ollama连接
                async testOllamaConnection() {
                    if (!this.ollamaConfig.ip || !this.ollamaConfig.port || !this.ollamaConfig.model) {
                        alert('请先配置Ollama大模型设置！');
                        return;
                    }

                    this.connectionStatus = { message: '正在测试连接...', success: null };
                    try {
                        const response = await fetch('/api/test_ollama_connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ip: this.ollamaConfig.ip,
                                port: parseInt(this.ollamaConfig.port),
                                model_name: this.ollamaConfig.model
                            })
                        });

                        const data = await response.json();
                        this.connectionStatus = data;
                    } catch (error) {
                        this.connectionStatus = { message: `连接测试失败: ${error.message}`, success: false };
                    }
                },

                // 保存Ollama配置
                saveOllamaConfig() {
                    if (!this.ollamaConfig.ip || !this.ollamaConfig.port || !this.ollamaConfig.model) {
                        alert('请填写完整的Ollama大模型设置！');
                        return;
                    }

                    // 保存到localStorage
                    localStorage.setItem('ollama_ip', this.ollamaConfig.ip);
                    localStorage.setItem('ollama_port', this.ollamaConfig.port);
                    localStorage.setItem('ollama_model', this.ollamaConfig.model);

                    alert('Ollama大模型配置已保存！');
                    this.testOllamaConnection(); // 重新测试连接
                },

                // 测试AI Ollama连接
                async testAiOllamaConnection() {
                    if (!this.aiOllamaConfig.ip || !this.aiOllamaConfig.port || !this.aiOllamaConfig.model) {
                        alert('请先配置AI Ollama大模型设置！');
                        return;
                    }

                    this.aiConnectionStatus = { message: '正在测试连接...', success: null };
                    try {
                        const response = await fetch('/api/test_ollama_connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ip: this.aiOllamaConfig.ip,
                                port: parseInt(this.aiOllamaConfig.port),
                                model_name: this.aiOllamaConfig.model
                            })
                        });

                        const data = await response.json();
                        this.aiConnectionStatus = data;
                    } catch (error) {
                        this.aiConnectionStatus = { message: `连接测试失败: ${error.message}`, success: false };
                    }
                },

                // 保存AI Ollama配置
                saveAiOllamaConfig() {
                    if (!this.aiOllamaConfig.ip || !this.aiOllamaConfig.port || !this.aiOllamaConfig.model) {
                        alert('请填写完整的AI Ollama大模型设置！');
                        return;
                    }

                    // 保存到localStorage
                    localStorage.setItem('ai_ollama_ip', this.aiOllamaConfig.ip);
                    localStorage.setItem('ai_ollama_port', this.aiOllamaConfig.port);
                    localStorage.setItem('ai_ollama_model', this.aiOllamaConfig.model);

                    alert('AI Ollama大模型配置已保存！');
                    this.testAiOllamaConnection(); // 重新测试连接
                },

                // 格式化题目内容
                formatQuestion(question) {
                    if (!question) return '';
                    // 将换行符转换为HTML换行标签
                    return question.replace(/\n/g, '<br>');
                },

                // 数据可视化相关方法
                async openDataVisualization() {
                    const modal = new bootstrap.Modal(document.getElementById('dataVisualizationModal'));
                    modal.show();

                    // 加载数据
                    await this.loadStudentExamData();
                },

                // 加载学生考试数据
                async loadStudentExamData() {
                    try {
                        // 并行加载数据
                        const [examsResponse, scoresResponse, knowledgeResponse] = await Promise.all([
                            fetch('/api/student/exams'),
                            fetch('/api/student/score'),
                            fetch('/api/student/knowledge')
                        ]);

                        const examsData = await examsResponse.json();
                        const scoresData = await scoresResponse.json();
                        const knowledgeData = await knowledgeResponse.json();

                        if (examsData.success) {
                            this.studentExams = examsData.exams;
                        }

                        if (scoresData.success) {
                            this.studentScores = scoresData.scores;
                            // 计算平均成绩
                            this.calculateAvgScore();
                            // 绘制成绩趋势图
                            this.drawScoreTrendChart();
                        }

                        if (knowledgeData.success) {
                            this.studentKnowledge = knowledgeData.knowledge;
                            // 绘制易错知识点图
                            this.drawKnowledgeChart();
                        }
                    } catch (error) {
                        console.error('加载学生考试数据失败:', error);
                    }
                },

                // 计算平均成绩
                calculateAvgScore() {
                    if (this.studentScores.length === 0) {
                        this.avgScore = 0;
                        return;
                    }

                    const total = this.studentScores.reduce((sum, score) => sum + Number(score.score), 0);
                    this.avgScore = Math.round(total / this.studentScores.length);
                },

                // 获取成绩等级
                getScoreLevel(score) {
                    if (score >= 90) return '优秀';
                    if (score >= 80) return '良好';
                    if (score >= 70) return '中等';
                    if (score >= 60) return '及格';
                    return '不及格';
                },

                // 获取成绩样式类
                getScoreClass(score) {
                    if (score >= 90) return 'bg-success';
                    if (score >= 80) return 'bg-primary';
                    if (score >= 70) return 'bg-info';
                    if (score >= 60) return 'bg-warning';
                    return 'bg-danger';
                },

                // 绘制成绩趋势图
                drawScoreTrendChart() {
                    const ctx = document.getElementById('scoreTrendChart').getContext('2d');

                    // 销毁现有图表
                    if (this.scoreTrendChart) {
                        this.scoreTrendChart.destroy();
                    }

                    // 准备数据
                    const labels = this.studentScores.map(score => score.test_name);
                    const scores = this.studentScores.map(score => score.score);

                    // 创建图表
                    this.scoreTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '成绩趋势',
                                data: scores,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#4f46e5',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 14
                                    },
                                    padding: 12,
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: '成绩',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: '考试名称',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                // 绘制易错知识点图
                drawKnowledgeChart() {
                    const ctx = document.getElementById('knowledgeChart').getContext('2d');

                    // 销毁现有图表
                    if (this.knowledgeChart) {
                        this.knowledgeChart.destroy();
                    }

                    // 准备数据
                    const labels = this.studentKnowledge.map(item => item.name);
                    const counts = this.studentKnowledge.map(item => item.count);

                    // 生成颜色数组
                    const colors = this.generateChartColors(labels.length);

                    // 创建图表
                    this.knowledgeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '易错知识点出现次数',
                                data: counts,
                                backgroundColor: colors,
                                borderColor: colors.map(color => color.replace('0.8', '1')),
                                borderWidth: 2,
                                borderRadius: 8,
                                barThickness: 30
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 14
                                    },
                                    padding: 12,
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '出现次数',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: '知识点',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 12
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                },

                // 生成图表颜色
                generateChartColors(count) {
                    const colors = [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(14, 165, 233, 0.8)',
                        'rgba(202, 138, 4, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(79, 70, 229, 0.8)'
                    ];

                    // 如果需要的颜色数量超过预定义的，重复使用
                    const result = [];
                    for (let i = 0; i < count; i++) {
                        result.push(colors[i % colors.length]);
                    }
                    return result;
                },

                // 打开题目生成模态框
                openQuestionGeneration() {
                    const modal = new bootstrap.Modal(document.getElementById('questionGenerationModal'));
                    modal.show();

                    // 从localStorage加载配置
                    const savedIp = localStorage.getItem('ollama_ip');
                    const savedPort = localStorage.getItem('ollama_port');
                    const savedModel = localStorage.getItem('ollama_model');

                    if (savedIp) this.ollamaConfig.ip = savedIp;
                    if (savedPort) this.ollamaConfig.port = savedPort;
                    if (savedModel) this.ollamaConfig.model = savedModel;

                    // 加载知识点列表
                    this.loadKnowledgeList();
                },

                // 加载知识点列表
                async loadKnowledgeList() {
                    try {
                        const response = await fetch('/api/get_knowledge_list');
                        const data = await response.json();
                        if (data.success) {
                            this.availableKnowledge = data.knowledge_list;
                        } else {
                            console.error('加载知识点列表失败:', data.message);
                        }
                    } catch (error) {
                        console.error('加载知识点列表失败:', error);
                    }
                },

                // 获取当前实时分数
                getCurrentScore() {
                    fetch('/api/get_current_score')
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                this.currentScore = data.score;
                            } else {
                                console.error('获取当前分数失败:', data.message);
                            }
                        })
                        .catch((error) => {
                            console.error('获取当前分数失败:', error);
                        });
                },
                
                // 获取完整的接线情况数据
                getWiringStatus() {
                    fetch('/api/get_score_and_contact')
                        .then((response) => response.json())
                        .then((data) => {
                            // 更新当前分数
                            this.currentScore = data.total_score;
                            
                            // 更新新增接线和拆除接线列表
                            if (data.add_pairs) {
                                this.addPairs = data.add_pairs;
                            }
                            if (data.undo_pairs) {
                                this.undoPairs = data.undo_pairs;
                            }
                            
                            // 从新增接线记录中获取最新的触点信息
                            if (this.addPairs.length > 0) {
                                const latestAddPair = this.addPairs[this.addPairs.length - 1];
                                if (latestAddPair.contact1 && latestAddPair.contact2) {
                                    this.latestContacts = [latestAddPair.contact1, latestAddPair.contact2];
                                }
                            }
                            
                            // 当有新的接线记录时，自动生成题目
                            if (this.addPairs.length > 0 || this.undoPairs.length > 0) {
                                this.autoGenerateQuestion();
                            }
                        })
                        .catch((error) => {
                            console.error('获取接线情况失败:', error);
                        });
                },

                openAiModelSettingModal() {
                    const modal = new bootstrap.Modal(document.getElementById('aiModelSettingModal'));
                    modal.show();
                }
            }
        });

        // 挂载Vue应用
        window.app.mount('#app');
        
        // 添加全局安全访问函数
        window.getAppProperty = function(propertyPath, defaultValue = null) {
            try {
                if (!window.app || !window.app.$data || !window.app.$data.ready) {
                    return defaultValue;
                }
                
                const properties = propertyPath.split('.');
                let result = window.app;
                
                for (const prop of properties) {
                    if (result && typeof result === 'object' && prop in result) {
                        result = result[prop];
                    } else {
                        return defaultValue;
                    }
                }
                
                return result;
            } catch (error) {
                console.warn('安全访问属性失败:', propertyPath, error);
                return defaultValue;
            }
        };
        
        // 添加全局日志函数，避免控制台错误
        window.logAppStatus = function() {
            const socketConnected = window.getAppProperty('socket.connected', false);
            const currentScore = window.getAppProperty('currentScore', 0);
            
            console.log('Socket.IO连接状态:', socketConnected);
            console.log('当前得分:', currentScore);
        };
        
        // 示例：使用安全访问函数
        // 可以在需要的地方调用 window.logAppStatus();
    </script>
</body>
</html>